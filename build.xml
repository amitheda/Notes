<project name="Notes" default="build" xmlns:flyway="antlib:org.flywaydb.ant">
 <target name="build" depends="clean,node,jshint,consolidate,specs"/>

<property name="jslint.cmd" value="jslint" />
<property name="jslint.tmp.alljs" value="${basedir}/public/js/" />
<property name="jslint.rules" value="--browser --predef $,document,jQuery, --sloppy" />

<target name="clean" unless="clean.done" description="Cleanup build artifacts">
  <delete dir="${basedir}/build/api"/>
  <delete dir="${basedir}/build/coverage"/>
  <delete dir="${basedir}/build/logs"/>
  <delete dir="${basedir}/build/pdepend"/>
  <delete dir="${basedir}/build/phpdox"/>
  <delete file="${basedir}/composer.lock"/>


  <delete dir="${basedir}/vendor"/>
  <delete file="${basedir}/app/Config/config.json"/>
  <delete file="${basedir}/build/tools/consolidated.js"/>
  <delete file="${basedir}/public/js/login-min.js"/>
  <delete file="${basedir}/npm-debug.log"/>
  
  <property name="clean.done" value="true"/>
 </target>
  <target name="node" depends="clean">
  <exec executable="npm" failonerror="true">
    <arg value="install" />
    <arg value="--no-bin-link" />
  </exec>
 </target>

    <!-- JSHint target, run separately -->
<target name="jshint">
  <apply dir="${basedir}/public/js/" executable="${basedir}/node_modules/jshint/bin/jshint" parallel="false" failonerror="true">
            <fileset dir="${basedir}/public/js/">
                <include name="**/View/*.js"/>
                <include name="**/Controller/*.js"/>
                <include name="**/Model/*.js"/>
            </fileset>
            <arg line="--verbose" />
            <arg line="--config" />
            <arg line="'${basedir}/jshint.jshintrc'" />
        </apply>
        <echo>JSHint Successful</echo>
</target>

 <target name="consolidate" depends="jshint">
    <echo>Consolidating...</echo>
    <concat id="srcfiles" destfile="${basedir}/build/tools/consolidated.js" append="true">
      <fileset dir="${basedir}/public/js/" includes="**/*.js" excludes="${basedir}/public/js/"/>
    </concat>
    <pathconvert pathsep=";" property="files" refid="srcfiles"/>
    <echo>${files}</echo>
    <echo>Finished.</echo>
</target>

<target name="minify" depends="consolidate">
    <echo>Minifying...</echo>
    <exec executable="java" dir="${basedir}/public/js/" failonerror="true">
        <arg line="-jar '${basedir}/build/tools/yuicompressor-2.4.7.jar'" />
        <arg line="--type js" />
        <arg line="-o 'login-min.js'" />
        <arg line="'${basedir}/build/tools/consolidated.js'" />
    </exec>
    <echo>Finished</echo>
</target>

 <target name="specs" depends="minify">
<echo>Running specs...</echo>
<exec executable="/usr/local/bin/phantomjs" failonerror="true">
    <arg line="${basedir}/tests/js/lib/phantom-jasmine-runner.js" />
    <arg line="${basedir}/tests/js/SpecRunner.html" />
</exec>
<echo>Finished.</echo>
</target>
</project>
